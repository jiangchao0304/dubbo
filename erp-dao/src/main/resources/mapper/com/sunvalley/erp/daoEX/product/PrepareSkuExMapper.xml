<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.sunvalley.erp.daoEX.product.PrepareSkuExMapper" >
	
	<select id="initByModel" parameterType="map" resultType="com.sunvalley.erp.modelEX.product.PrepareSkuEx">
		SELECT
			model.model_id modelId,
			model.model_name model,
			model.brand_id brandId,
			brand.brand_desc brandDesc,
			model.pm_id pmId,
			CONCAT(
				sysu.firstname,
				'.',
				sysu.lastname
			) pmName,
			mianline.product_code mainBrandCode,
			mianline.id mainCategoryId,
			brand.brand_code mainModelNo,
			subline.model_no subModelNo,
			subline.id subCategoryId,
			subline.product_code subBrandCode,
			common.custom_name customName,
			common.sale_dept saleDept,
			common.standard_size standardSize,
			common.weight weight,
			common.shipping_type shippingType,
			common.mc mc,
			common.sale_price salePrice,
			common.setup_date setupDate,
            model.remark model_remark
		FROM
			bs_item_model model
		INNER JOIN bs_item_brand brand ON model.brand_id = brand.brand_id
		LEFT JOIN sys_user sysu ON sysu.userid = model.pm_id
		LEFT JOIN bs_item_pre_commom common ON model.model_id = common.model_id
		LEFT JOIN bs_product_line mianline ON model.main_category_id = mianline.id
		AND mianline.product_type = 2
		LEFT JOIN bs_product_line subline ON model.sub_category_id = subline.id
		AND subline.product_type = 3
		WHERE
			model.model_name = #{model}
	</select>

	<select id="preSkuGrid" parameterType="map" resultType="com.sunvalley.erp.domain.product.dto.PreSkuGridDTO">
		SELECT
			pre.id id,
			pre.pre_sku preSku,
			pre.product_name productName,
			pre.sku sku,
			anrule.anruleStr anruleStr,
			anrule.anrule anrule,
			pre.color color,
			basic.attribute colorStr,
			country.country country,
			pre.sale_qty saleQty,
			pre.market_capacity marketCapacity,
			pre.rma_ratio rmaRatio,
			pre.mp_date mpDate,
			pre.region saleZone,
			pre.`status` STATUS,
			pre.remark remark
		FROM
			bs_prepare_sku pre
		LEFT JOIN bs_item_basic_data basic ON basic.`value` = pre.color
		AND basic.type = 1
		LEFT JOIN (
			SELECT
				mapping.skuid skuid,
				group_concat(basic.attribute) anruleStr,
				group_concat(basic. VALUE) anrule
			FROM
				bs_item_mapping mapping
			LEFT JOIN bs_item_basic_data basic ON mapping.maping = basic.`value`
			WHERE
				mapping.data_type = 1
			AND basic.type = 2
			GROUP BY
				mapping.skuid
		) anrule ON pre.id = anrule.skuid
		LEFT JOIN (
			SELECT
				mapping.skuid skuid,
				group_concat(mapping.maping) country
			FROM
				bs_item_mapping mapping
			WHERE
				mapping.data_type = 2
			GROUP BY
				mapping.skuid
		) country ON country.skuid = pre.id
		WHERE (1=1)
		<if test="model_id != null">
			and model_id =  #{model_id}
	    </if>
		<if test="status != null">
			and pre.status =  #{status}
	    </if>
	    <if test="id != null">
			and pre.id =  #{id}
	    </if>
	    <if test="preSku != null">
			and pre.pre_sku =  #{preSku}
	    </if>
	</select>
	
	<select id="packageSkuList" parameterType="map" resultType="com.sunvalley.erp.domain.product.dto.PackageSkuDTO">
		SELECT
			item.sku sku,
			anrule.anruleStr anruleStr,
			anrule.anrule anrule,
			basic.attribute colorStr
		FROM
			bs_item item
		LEFT JOIN (
			SELECT
				mapping.skuid skuid,
				group_concat(basic.attribute) anruleStr,
				group_concat(basic. VALUE) anrule
			FROM
				bs_item_mapping mapping
			LEFT JOIN bs_item_basic_data basic ON mapping.maping = basic.`value`
			WHERE
				mapping.data_type = 1
			AND basic.type = 2
			GROUP BY
				mapping.skuid
		) anrule ON item.skuid = anrule.skuid
		LEFT JOIN bs_item_basic_data basic ON item.color = basic.`value`
		AND basic.type = 1
		WHERE
			item.is_package = 2
		AND item.model = #{model}
	</select>

	 
</mapper>